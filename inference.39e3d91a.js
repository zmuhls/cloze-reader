function e(e,t,r,n){Object.defineProperty(e,t,{get:r,set:n,enumerable:!0,configurable:!0})}var t=globalThis,r={},n={},a=t.parcelRequired201;null==a&&((a=function(e){if(e in r)return r[e].exports;if(e in n){var t=n[e];delete n[e];var a={id:e,exports:{}};return r[e]=a,t.call(a.exports,a,a.exports),a.exports}var o=Error("Cannot find module '"+e+"'");throw o.code="MODULE_NOT_FOUND",o}).register=function(e,t){n[e]=t},t.parcelRequired201=a);var o=a.register;o("6nwBV",function(t,r){e(t.exports,"getEnvironmentConfig",()=>i),e(t.exports,"isUsingUserProvidedApiKey",()=>s),e(t.exports,"setUserApiKey",()=>l);var n=a("gAFfX");function o(){return window.location.hostname.includes("github.io")||"cloze-reader.vercel.app"===window.location.hostname||"file:"===window.location.protocol}function i(){let e=o(),t=localStorage.getItem("openrouter_api_key"),r=!!t&&t.startsWith("sk-or-")&&t.length>20,a=atob("c2stb3ItdjEtNGY4MmQ3NDBlZmQyNjlhY2IwYTA4MGIzMTgyNTQ5NDlhMTQ5Y2FlYTZmNzFkODAxMGM0MDJkNWQ5ZGViYjQ1Zg=="),i=e?a:r?t:a;return(0,n.debugLog)("Environment config loaded",{isRemoteInterface:e,usingUserKey:!e&&r,keyFormat:i.substring(0,8)+"..."}),{OPENROUTER_API_KEY:i,IS_REMOTE_INTERFACE:e}}function s(){if(o())return!1;let e=localStorage.getItem("openrouter_api_key");return!!e&&e.startsWith("sk-or-")&&e.length>20}function l(e){if(o())return(0,n.debugLog)("Cannot set custom API key in remote interface"),!1;let t=e.trim();return!!(t&&t.startsWith("sk-or-"))&&t.length>20&&(localStorage.setItem("openrouter_api_key",t),!0)}}),o("gAFfX",function(t,r){e(t.exports,"debugLog",()=>n);function n(e,t){let r=new Date().toISOString();if(console.log(`[DEBUG ${r}] ${e}`),void 0!==t)try{let e=JSON.stringify(t,(e,t)=>t instanceof HTMLElement?`HTMLElement (${t.tagName}${t.id?"#"+t.id:""})`:t,2);console.log(e)}catch(e){console.log("[DEBUG Data Stringify Error]",e),console.log("[DEBUG Raw Data]",t)}}}),o("59ye1",function(t,r){e(t.exports,"initializeGameDOMElements",()=>f),e(t.exports,"resetGame",()=>b),e(t.exports,"startRound",()=>w),e(t.exports,"handleSubmission",()=>x);var n=a("gAFfX"),o=a("64gHy");let i={cache:{},maxSize:10,set:function(e,t){if(Object.keys(this.cache).length>=this.maxSize){let e=Object.keys(this.cache)[0];delete this.cache[e]}this.cache[e]={value:t,timestamp:Date.now()};try{localStorage.setItem("paragraphCache",JSON.stringify(this.cache))}catch(e){console.warn("Could not save cache to localStorage",e)}},get:function(e){let t=this.cache[e];if(!t)return null;if(Date.now()-t.timestamp>864e5){delete this.cache[e];try{localStorage.setItem("paragraphCache",JSON.stringify(this.cache))}catch(e){console.warn("Could not update cache in localStorage",e)}return null}return t.value},init:function(){try{let e=localStorage.getItem("paragraphCache");e&&(this.cache=JSON.parse(e))}catch(e){console.warn("Could not load cache from localStorage",e),this.cache={}}}};function s(e,t){let r=[];if(0===e.length||0===t)return r;let n=new Set(["the","a","an","and","or","but","if","of","at","by","for","with","about","to","from","in","on","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","shall","should","can","could","may","might","must","that","which","who","whom","whose","this","these","those","am","i","we","you","he","she","they","we","it"]),a=e.map((e,t)=>{let r,a=e.toLowerCase().replace(/[^\w]/g,"");return r=0+2*a.length,n.has(a)&&(r-=10),t>0&&e[0]===e[0].toUpperCase()&&e[0].match(/[A-Z]/)&&(r+=5),{index:t,score:r+=2*Math.random()}});a.sort((e,t)=>t.score-e.score);let o=Math.min(t,e.length),i=Math.min(2*o,e.length),s=a.slice(0,i);for(;r.length<o&&s.length>0;){let e=Math.floor(Math.random()*s.length),t=s.splice(e,1)[0];r.push(t.index)}return r.sort((e,t)=>e-t)}i.init();let l=[[],[]],c=[[],[]],d=1,h=1,u=5,g=new Set,p=[],m=null;function f(e){m=e}function y(){if(!m)return void console.error("DOM elements not initialized for gameLogic.renderRound");let{gameArea:e,roundInfo:t,submitBtn:r,hintBtn:n,resultArea:a}=m,o=c[0].length+c[1].length;if(t.textContent=`Round ${d} \u{2014} ${o} blanks`,e.innerHTML="",0===l[0].length&&0===l[1].length){e.innerHTML='<p class="text-red-500">Error: No paragraphs loaded.</p>',r.disabled=!0,n.disabled=!0;return}for(let t=0;t<2;t++){if(0===l[t].length)continue;let n=document.createElement("p");n.className="typewriter-text leading-relaxed break-words mb-6",n.style.maxWidth="100%",n.style.overflowWrap="break-word",e.appendChild(n),l[t].forEach((a,o)=>{if(c[t].includes(o)){let a=document.createElement("input");a.type="text",a.dataset.index=String(o),a.dataset.paragraph=String(t),a.placeholder="_____",a.className="border-b-2 border-typewriter-ink w-24 mx-1 text-center bg-transparent focus:outline-none focus:border-typewriter-ribbon focus:ring-1 focus:ring-typewriter-ribbon rounded-sm px-1 py-0.5 text-typewriter-ink placeholder-typewriter-ink placeholder-opacity-50",a.addEventListener("keydown",e=>{1===e.key.length&&(a.classList.add("shadow-typewriter-pressed"),setTimeout(()=>a.classList.remove("shadow-typewriter-pressed"),100))}),a.addEventListener("input",()=>{r.disabled=!Array.from(e.querySelectorAll('input[type="text"]')).every(e=>""!==e.value.trim())}),n.appendChild(a),n.appendChild(document.createTextNode(" ")),a.addEventListener("focus",()=>{if(!m)return;let e=Number(a.dataset.paragraph),t=Number(a.dataset.index),r=`${e}-${t}`;m.hintBtn.disabled=u<=0||g.has(r),m.hintBtn.onclick=()=>{if(u>0&&!g.has(r)){let n=l[e][t];if(n){let e=`Starts with "${n[0]}", length ${n.length}.`,t=document.createElement("div");t.className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50",t.innerHTML=`
                  <div class="bg-aged-paper p-6 rounded shadow-typewriter max-w-md text-center typewriter-text">
                    <h3 class="text-xl font-bold mb-4 text-shadow-typewriter">Hint</h3>
                    <p>${e}</p>
                    <button class="mt-4 px-4 py-2 typewriter-key hover:bg-aged-paper">Got it</button>
                  </div>
                `,document.body.appendChild(t);let o=()=>document.body.removeChild(t);t.querySelector("button")?.addEventListener("click",o),t.addEventListener("click",e=>{e.target===t&&o()}),u--,m&&(m.hintBtn.textContent=`Hint (${u})`),g.add(r),a.classList.add("hinted-blank"),m&&(m.hintBtn.disabled=u<=0||g.has(r))}}}})}else{let e=document.createElement("span");e.textContent=a+" ",e.className="typewriter-text",n.appendChild(e)}})}let i=c[0].length+c[1].length;r.disabled=0===i,n.disabled=u<=0||0===i,a.textContent="","function"==typeof startTimer&&startTimer(),setTimeout(()=>{"undefined"!=typeof window&&window.applyTypewriterEffect&&window.applyTypewriterEffect()},100)}function b(){if(!m)return void console.error("DOM elements not initialized for gameLogic.resetGame");let{gameArea:e,resultArea:t,roundInfo:r,bibliographicArea:a}=m;d=1,h=1,u=5,g.clear(),l[0]=[],l[1]=[],c[0]=[],c[1]=[],p=[],e&&(e.innerHTML=""),t&&(t.textContent=""),r&&(r.textContent=""),a&&(a.innerHTML=""),"function"==typeof stopTimer&&stopTimer(),(0,n.debugLog)("Game reset in gameLogic.ts")}async function w(e=!1){if(!m)return void console.error("DOM elements not initialized for gameLogic.startRound");let{gameArea:t,roundInfo:r,submitBtn:a,hintBtn:d,resultArea:f,bibliographicArea:b}=m;u=3,d&&(d.textContent=`Hint (${u})`),a&&(a.disabled=!0),d&&(d.disabled=!0),t&&(t.innerHTML='<div class="text-center p-4"><p class="text-lg typewriter-text">Fetching new paragraphs from Gutenberg...</p><p class="text-sm mt-2 text-opacity-70">*click* *clack* *ding*</p></div>'),f&&(f.textContent=""),g.clear(),"function"==typeof stopTimer&&stopTimer(),b&&(b.innerHTML="");let x=localStorage.getItem("game_category")||"",v=localStorage.getItem("game_author")||"",L=localStorage.getItem("game_century")||"",E=`passage_${x||"any"}_${v||"any"}_${L||"any"}`;x||v||L||!e||(E=`passage_random_${Date.now()}_${Math.random().toString(36).substring(7)}`,(0,n.debugLog)("Generated unique cache key for initial random passage:",{cacheKey:E}));let k=i.get(E);if(e||!k||E.startsWith("passage_random_")){e?(0,n.debugLog)("Forcing new passage fetch, bypassing cache.",{cacheKey:E}):(0,n.debugLog)("Cache miss or invalid cache data. Fetching new passage.",{cacheKey:E});let r=null;try{if(!(r=await (0,o.fetchGutenbergPassage)(x,v,L,[]))||0===r.paragraphs.length){t&&(t.innerHTML='<div class="text-center p-4"><p class="text-lg text-red-500 typewriter-text">Could not load a suitable passage after multiple attempts. Please check your API key, network, or try different search criteria.</p></div>'),a&&(a.disabled=!0),d&&(d.disabled=!0),"function"==typeof stopTimer&&stopTimer();return}try{i.set(E,JSON.stringify(r)),(0,n.debugLog)("Passage stored in cache",{cacheKey:E})}catch(e){console.warn("Failed to store passage in cache:",e)}if(l[0]=r.paragraphs[0].split(/\s+/).filter(e=>e.length>0),l[1]=r.paragraphs.length>1?r.paragraphs[1].split(/\s+/).filter(e=>e.length>0):[],b&&r&&r.metadata){!p.some(e=>e.id===r.metadata.id)&&(p.unshift(r.metadata),p.length>5&&p.pop());let e="";p.length>1&&(e='<p class="text-xs text-typewriter-ink opacity-60 mt-1">Previously fetched:</p><ul class="text-xs list-disc list-inside opacity-60">',p.slice(1,5).forEach(t=>{e+=`<li><a href="https://www.gutenberg.org/ebooks/${t.id}" target="_blank" class="underline hover:text-typewriter-ribbon">${t.title} by ${t.author}</a></li>`}),e+="</ul>"),b.innerHTML=`
            <p class="text-sm text-typewriter-ink opacity-80 mb-1">
                Currently from: <em><a href="https://www.gutenberg.org/ebooks/${r.metadata.id}" target="_blank" class="underline hover:text-typewriter-ribbon">${r.metadata.title}</a></em> by ${r.metadata.author} (ID: ${r.metadata.id})
            </p>
            ${e}
        `,setTimeout(()=>{"undefined"!=typeof window&&window.applyTypewriterEffect&&b.querySelectorAll("p, em, a, li").forEach(e=>window.applyTypewriterEffect(e))},100)}}catch(e){console.error("Error fetching passage:",e),t&&(t.innerHTML='<div class="text-center p-4"><p class="text-lg text-red-500 typewriter-text">An error occurred while fetching content. Please check your API key and network connection.</p></div>'),a&&(a.disabled=!0),d&&(d.disabled=!0),"function"==typeof stopTimer&&stopTimer();return}if(!r)return;c[0].length=0,c[1].length=0;let u=l[0].length+l[1].length,g=Math.min(h,Math.floor(.3*u));if(l[0].length>0){let e=l[1].length>0?Math.floor(g*(l[0].length/u)):g;s(l[0],e).forEach(e=>c[0].push(e))}if(l[1].length>0){let e=g-c[0].length;s(l[1],e).forEach(e=>c[1].push(e))}if(c[0].length+c[1].length===0){t&&(t.innerHTML='<div class="text-center p-4"><p class="text-lg text-red-500 typewriter-text">Could not generate enough blanks. Try different criteria or refresh.</p></div>'),a&&(a.disabled=!0),d&&(d.disabled=!0),"function"==typeof stopTimer&&stopTimer();return}y()}else{(0,n.debugLog)("Serving passage from cache",{cacheKey:E});let e=JSON.parse(k);if(e&&e.paragraphs&&Array.isArray(e.paragraphs)){let r={paragraphs:e.paragraphs,metadata:e.metadata||null};if(b&&r.metadata){!p.some(e=>e.id===r.metadata.id)&&(p.unshift(r.metadata),p.length>5&&p.pop());let e="";p.length>1&&(e='<p class="text-xs text-typewriter-ink opacity-60 mt-1">Previously fetched:</p><ul class="text-xs list-disc list-inside opacity-60">',p.slice(1,5).forEach(t=>{e+=`<li><a href="https://www.gutenberg.org/ebooks/${t.id}" target="_blank" class="underline hover:text-typewriter-ribbon">${t.title} by ${t.author}</a></li>`}),e+="</ul>"),b.innerHTML=`
                <p class="text-sm text-typewriter-ink opacity-80 mb-1">
                    (Cached) Currently from: <em><a href="https://www.gutenberg.org/ebooks/${r.metadata.id}" target="_blank" class="underline hover:text-typewriter-ribbon">${r.metadata.title}</a></em> by ${r.metadata.author} (ID: ${r.metadata.id})
                </p>
                ${e}
            `,setTimeout(()=>{"undefined"!=typeof window&&window.applyTypewriterEffect&&b.querySelectorAll("p, em, a, li").forEach(e=>window.applyTypewriterEffect(e))},100)}l[0]=r.paragraphs[0].split(/\s+/).filter(e=>e.length>0),l[1]=r.paragraphs.length>1?r.paragraphs[1].split(/\s+/).filter(e=>e.length>0):[],c[0].length=0,c[1].length=0;let n=l[0].length+l[1].length,o=Math.min(h,Math.floor(.3*n));if(l[0].length>0){let e=l[1].length>0?Math.floor(o*(l[0].length/n)):o;s(l[0],e).forEach(e=>c[0].push(e))}if(l[1].length>0){let e=o-c[0].length;s(l[1],e).forEach(e=>c[1].push(e))}return c[0].length+c[1].length===0?(t&&(t.innerHTML='<div class="text-center p-4"><p class="text-lg text-red-500 typewriter-text">Could not generate enough blanks from cached passage. Try different criteria or refresh.</p></div>'),a&&(a.disabled=!0),d&&(d.disabled=!0),"function"==typeof stopTimer&&stopTimer(),null):(y(),r)}console.warn("Cached data for key",E,"is invalid. Fetching new.")}}async function x(e=!1){if(!m)return void console.error("DOM elements not initialized for gameLogic.handleSubmission");let{gameArea:t,submitBtn:r,hintBtn:n,resultArea:a}=m;"function"==typeof stopTimer&&stopTimer();let o=Array.from(t.querySelectorAll('input[type="text"]')),i=0,s=0;o.forEach(e=>{s++;let t=Number(e.dataset.paragraph||"0"),r=Number(e.dataset.index),n=l[t][r],a=e.value.trim(),o=n.replace(/[^\w\s'-]/g,"").toLowerCase(),c=a.toLowerCase(),d=document.createElement("span");d.className="typewriter-text font-bold",c===o?(i++,d.textContent=n+" ",d.classList.add("text-green-700")):(d.textContent=`${a} [${n}] `,d.classList.add("text-red-700")),e.parentElement?.insertBefore(d,e),e.remove()});let c=Math.ceil(.6*s);a.classList.remove("text-green-700","text-red-700"),e?a.textContent=`Time's up! You got ${i}/${s} correct.`:a.textContent=`${i}/${s} correct.`,a.classList.add(i>=c?"text-green-700":"text-red-700","text-shadow-typewriter"),i>=c?(d++,h++,a&&(a.textContent+=` Starting Round ${d} with ${h} blanks in 8 seconds...`)):a&&(a.textContent+=" Getting a new passage in 8 seconds..."),r&&(r.disabled=!0),n&&(n.disabled=!0),i>=c?setTimeout(()=>w(!1),8e3):setTimeout(()=>w(!0),8e3)}}),o("64gHy",function(t,r){let n,o,i,s,l,c,d;e(t.exports,"fetchGutenbergPassage",()=>m);var h=a("gAFfX"),u=a("6nwBV"),g=a("84ah7"),p=a("59ye1");async function m(e=null,t=null,r=null,n=[]){(0,h.debugLog)("Fetching Gutenberg passage",{category:e,author:t,century:r,attempt:n.length+1});let a=!!(0,u.getEnvironmentConfig)().OPENROUTER_API_KEY,o=(0,u.isUsingUserProvidedApiKey)(),i=window.location.hostname.includes("github.io");if((0,h.debugLog)("Environment check",{hasValidApiKey:a,isUsingCustomKey:o,isGitHubPages:i,hostname:window.location.hostname,apiKeyFormat:(0,u.getEnvironmentConfig)().OPENROUTER_API_KEY.substring(0,8)+"...",forceFallback:!1,tempForceFallback:!1}),!a){let t;console.warn("Using fallback passage due to missing API key or forced fallback.");let r={title:"Fallback Passage",author:"Anonymous",id:0};return"adventure"===e?(t=`The intrepid explorer ventured deeper into the uncharted jungle, sweat beading on his brow as he hacked through the dense undergrowth with his machete. Strange bird calls echoed through the canopy above, and the air hung thick with moisture and the sweet scent of exotic flowers. He knew the lost temple lay somewhere ahead, its ancient stones hiding secrets that had remained untouched for centuries.

As night fell, he made camp beside a small stream, the gentle gurgling of water over stones providing a soothing counterpoint to the mysterious sounds of the jungle. His maps were worn and faded, but they had served him well thus far. Tomorrow would bring new challenges and, perhaps, the discovery that would cement his place in the annals of exploration.`,r={title:"Adventure Story Excerpt",author:"Various Authors",id:0}):"science"===e?(t=`The laboratory hummed with the soft whirring of centrifuges and the occasional beep of monitoring equipment. Dr. Chen carefully pipetted the clear solution into a series of test tubes, her steady hands reflecting years of practiced precision. This experiment represented months of theoretical work, and if successful, could fundamentally alter our understanding of cellular regeneration.

Scientific discovery has always balanced on the knife-edge between methodical process and creative insight. The greatest breakthroughs often come not from following established protocols, but from the moments when researchers question fundamental assumptions and pursue the unexpected anomalies that appear in their data. It is this combination of discipline and imagination that drives progress forward.`,r={title:"Scientific Musings",author:"Various Authors",id:0}):(t=`The ability to think clearly and rationally is essential for making good decisions and solving problems effectively. Critical thinking involves analyzing information objectively and making reasoned judgments based on evidence rather than personal bias or emotional reactions. It requires skills such as attention to detail, logical reasoning, and the willingness to question assumptions.

Throughout history, literature has served as a mirror reflecting the values, concerns, and aspirations of society. Books allow us to experience different perspectives, fostering empathy and understanding across cultural divides. Whether through fiction or non-fiction, the written word preserves human knowledge and invites readers to engage with ideas that may challenge or expand their worldview.`,r={title:"General Knowledge Excerpt",author:"Various Authors",id:0}),{paragraphs:t.split(/\n+/).filter(e=>e.trim().length>0),metadata:r}}for(let a=0;a<3;a++){let o;(0,h.debugLog)(`Fetch attempt ${a+1} of 3. Attempted IDs: ${n.join(", ")}`);let i=[];if(t&&i.push(`by author "${t}"`),e)if(e.includes("/")){let t=e.split("/")[1];t?(i.push(`in the Gutenberg bookshelf ID "${t}"`),(0,h.debugLog)(`Using bookshelf ID "${t}" from category "${e}".`)):(0,h.debugLog)(`Could not extract bookshelf ID from category "${e}". Category will be ignored.`)}else i.push(`in the category "${e}"`);if(r){let e=parseInt(r);isNaN(e)||i.push(`from the ${e+1}th century`)}let s=i.join(" ");i.length>0?(o=`from Project Gutenberg ${s}`,(0,h.debugLog)("Specific criteria provided: using standard query string.")):(o="from a truly random book in classic literature, prioritizing high variety and diverse selections. Please try to pick something unexpected or less common to ensure a unique experience.",(0,h.debugLog)("No specific criteria: using new enhanced random query string for initial fetch."));let l="";a>0&&(l=` This is attempt ${a+1}. Please ensure you select a *different* book than previous attempts.`),n.length>0&&(l+=` Avoid Project Gutenberg IDs: ${n.join(", ")}.`);let c=[{role:"system",content:"You are an assistant that helps find and display literary passages from Project Gutenberg. Please provide the passage text along with its title, author, and Project Gutenberg ID if available. Prioritize finding a passage, even if specific search criteria (like category, author, or century) are suggestions and cannot all be met. Avoid adding commentary or analysis not present in the original text."},{role:"user",content:`Please provide a short literary passage (2-3 paragraphs) from Project Gutenberg.
${o?`Ideally, the passage should be ${o}.`:"The passage can be from any classic literary work."}
${l}
Include the title, author, and Project Gutenberg ID if available.

Format suggestion:
Title: [Book Title]
Author: [Book Author]
ID: [Book ID]
Passage:
[The passage text]

If no passage can be found, please indicate that. Focus on returning a passage, even if all criteria cannot be perfectly met.`}];try{let e=0===i.length?1.2:void 0;(0,h.debugLog)(`LLM call (attempt ${a+1}) with temperature: ${void 0===e?"default":e}`);let t=await (0,g.runAgenticLoop)(c,[],e);if(!t){if(console.error(`LLM call (attempt ${a+1}) returned no content.`),2===a)return null;await new Promise(e=>setTimeout(e,1e3));continue}(0,h.debugLog)(`LLM Web Search Response for Passage (attempt ${a+1}):`,t);let r="Unknown Title",o="Unknown Author",s=null,l="",d=t.match(/Title:\s*(.*)/i);d&&d[1]&&(r=d[1].trim());let u=t.match(/Author:\s*(.*)/i);u&&u[1]&&(o=u[1].trim());let p=t.match(/ID:\s*(\d+)/i);p&&p[1]&&(s=parseInt(p[1],10)),null===s||n.includes(s)||n.push(s);let m="Passage:",f=t.indexOf(m);if(-1!==f)l=t.substring(f+m.length).trim();else{let e=0;d&&(e=Math.max(e,(d.index||0)+d[0].length)),u&&(e=Math.max(e,(u.index||0)+u[0].length)),p&&(e=Math.max(e,(p.index||0)+p[0].length)),e>0&&e<t.length?l=t.substring(e).trim():d||u||p||(l=t.trim(),(0,h.debugLog)("No metadata markers found, assuming entire response is passage text."))}if(!l||t.toLowerCase().includes("no suitable passage found")){if(console.warn(`Attempt ${a+1}: Could not extract passage text or LLM indicated no passage found.`),2===a)return null;await new Promise(e=>setTimeout(e,1e3));continue}let y=l.split(/\n\s*\n/).map(e=>e.trim()).filter(e=>e.length>150&&!e.startsWith("Project Gutenberg")&&!e.startsWith("***")&&!e.includes("*** END OF ")&&!e.startsWith("THE END")&&!e.includes("www.gutenberg.org")&&!/^\*+$/.test(e)).slice(0,10);if(y.length<2&&((0,h.debugLog)(`Attempt ${a+1}: First parsing didn't yield enough paragraphs, trying alternative.`),y=l.replace(/\r\n/g,"\n").split(/(?:\n\s*){2,}/).map(e=>e.replace(/\n/g," ").trim()).filter(e=>e.length>150&&!e.includes("Project Gutenberg")).slice(0,10)),y.sort((e,t)=>{let r=Math.min(e.length,1e3)-Math.max(0,2e3-e.length)+200*!!e.match(/[.!?][\s"']/);return Math.min(t.length,1e3)-Math.max(0,2e3-t.length)+200*!!t.match(/[.!?][\s"']/)-r}),y=y.slice(0,2),0===y.length&&(0,h.debugLog)(`Attempt ${a+1}: Failed to extract suitable paragraphs after all parsing attempts.`),y.length>0)return console.log(`Attempt ${a+1}: Successfully extracted ${y.length} paragraphs.`),{paragraphs:y,metadata:{title:r,author:o,id:null!==s?s:0}};console.warn(`Attempt ${a+1}: Could only extract ${y.length} suitable paragraphs. Retrying if attempts remain.`)}catch(e){console.error(`Error in fetchGutenbergPassage (LLM web search, attempt ${a+1}):`,e)}a<2&&await new Promise(e=>setTimeout(e,1e3*(a+1)))}return console.error("Failed to fetch a suitable passage after all retries."),null}function f(e,t=document){let r=t.querySelector(e);return r||(console.warn(`Element with selector "${e}" not found.`),null)}"undefined"!=typeof window&&(window.startRound=p.startRound,console.log("Added global functions to window object")),document.addEventListener("DOMContentLoaded",()=>{try{n=f("#bibliographic-area")||document.createElement("div"),o=f("#game-area")||document.createElement("div"),i=f("#result")||document.createElement("div"),s=f("#hint-btn")||document.createElement("button"),l=f("#submit-btn")||document.createElement("button"),c=f("#round-info")||document.createElement("div"),d=f("#new-text-btn")||document.createElement("button"),f("#welcome-overlay")||document.createElement("div"),f("#start-game-btn")||document.createElement("button"),console.log("DOM Elements cached successfully:",{gameAreaFound:!!document.querySelector("#game-area"),welcomeOverlayFound:!!document.querySelector("#welcome-overlay"),startGameBtnFound:!!document.querySelector("#start-game-btn")}),(0,p.initializeGameDOMElements)({gameArea:o,roundInfo:c,submitBtn:l,hintBtn:s,resultArea:i,bibliographicArea:n})}catch(e){console.error("Error caching DOM elements:",e)}d.addEventListener("click",async()=>{await (0,p.startRound)(!0)}),l.addEventListener("click",()=>(0,p.handleSubmission)())})}),o("84ah7",function(t,r){e(t.exports,"runAgenticLoop",()=>d);var n=a("gAFfX"),o=a("6nwBV");let i={};function s(e,t){(0,n.debugLog)(`[LLM Service Tool Call] ${e}`,t)}async function l(e,t,r){let a={model:"google/gemini-flash-1.5:online",messages:e};void 0!==r&&(a.temperature=r,(0,n.debugLog)("LLM Service: Using custom temperature",r)),t&&t.length>0?(a.tools=t,a.tool_choice="auto",(0,n.debugLog)("LLM Service: Using tools",t)):(0,n.debugLog)("LLM Service: No specific tools provided, relying on web search via :online model suffix."),(0,n.debugLog)("LLM Service: OpenRouter API Request",a);try{let e=(0,o.getEnvironmentConfig)().OPENROUTER_API_KEY,t=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","HTTP-Referer":"undefined"!=typeof window?window.location.href:"","X-Title":"Cloze"},body:JSON.stringify(a)});if(!t.ok){let e;try{e=await t.json()}catch(r){e=await t.text()}let r="object"==typeof e&&e?.error?.message?e.error.message:"string"==typeof e?e:"Unknown API error";throw console.error("LLM Service: OpenRouter API Error:",t.status,r),Error(`OpenRouter API Error: ${t.status} - ${r}`)}let r=await t.json();if((0,n.debugLog)("LLM Service: OpenRouter API Response",r),!r.choices||!r.choices[0]||!r.choices[0].message)throw console.error("LLM Service: Invalid response structure from OpenRouter:",r),Error("Invalid response structure from OpenRouter.");return r.choices[0].message}catch(e){throw console.error("LLM Service: Error calling OpenRouter API:",e),e}}async function c(e){let t;if(!e.tool_calls||0===e.tool_calls.length)throw Error("Assistant response does not contain tool calls.");let r=e.tool_calls[0],n=r.function.name;s("Received tool call",{toolName:n,toolCallId:r.id});try{t=JSON.parse(r.function.arguments),s("Parsed tool arguments",t)}catch(e){return console.error("LLM Service: Failed to parse tool arguments:",e),{role:"tool",tool_call_id:r.id,name:n,content:JSON.stringify({error:`Invalid JSON in tool arguments: ${e.message}`})}}let a=i[n];if(!a)return console.error(`LLM Service: Tool ${n} not found in TOOL_MAPPING.`),{role:"tool",tool_call_id:r.id,name:n,content:JSON.stringify({error:`Tool ${n} not found.`})};try{s("Executing tool function",{name:n});let e=await a(t);return s("Tool execution result",e),{role:"tool",tool_call_id:r.id,name:n,content:JSON.stringify(e)}}catch(e){return console.error(`LLM Service: Error executing tool ${n}:`,e),{role:"tool",tool_call_id:r.id,name:n,content:JSON.stringify({error:`Error executing tool ${n}: ${e.message}`})}}}async function d(e,t,r){let a=[...e];for(let e=0;e<5;e++){(0,n.debugLog)(`LLM Service: Agentic Loop Iteration ${e+1}`);let o=await l(a,t,r);if(a.push(o),!o.tool_calls||!(o.tool_calls.length>0))return o.content??null;{let e=await c(o);a.push(e)}}console.warn("LLM Service: Agentic loop reached max iterations.");let o=a.length>0?a[a.length-1]:null;return o&&"assistant"===o.role&&o.content?o.content:"Agentic loop completed without a final assistant message or an error occurred."}}),a("64gHy");
//# sourceMappingURL=inference.39e3d91a.js.map
